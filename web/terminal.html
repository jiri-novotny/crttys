<!doctype html>
  <html>
    <head>
      <link rel="stylesheet" href="https://unpkg.com/xterm@4.13.0/css/xterm.css" />
      <script src="https://unpkg.com/xterm@4.13.0/lib/xterm.js"></script>
      <title>Device proxy - Terminal</title>
    </head>
    <body>
      <div id="terminal"></div>
      <script>
        var term = new Terminal();
        var init = 0;
        var deviceid = "";
        var dnl;

        term.open(document.getElementById('terminal'));
        term.onResize(e => {
          ws.send("size:" + e.cols + "x" + e.rows);
        });
        term.onData(e => {
          if (ws.readyState === WebSocket.OPEN)
          {
            ws.send("data:" + e);
          }
          else if (ws.readyState == WebSocket.CLOSED)
          {
            switch (e) {
              case '\u001b[15~': // F5 override
                location.reload();
                break;
              case '\u001b[19~': // F8 override
                var ws2 = new WebSocket(ws.url);
                ws2.onopen = ws.onopen;
                ws2.onmessage = ws.onmessage;
                ws2.onclose = ws.onclose;
                ws2.onerror = ws.onerror;
                ws = ws2;
                term.write('\r\n\r\n\x1B[1;3;32mConnection is restored.\x1B[0m\r\n'); 
                break;
            }
          }
        });

        if ("WebSocket" in window) {
          var ws = new WebSocket(window.location.origin.replace('http', 'ws') + "/ws");
          ws.onopen = () => {
            init = 0;
            deviceid = window.location.pathname;
            if (deviceid.slice(-1) === '/')
              deviceid = deviceid.slice(1, -1);
            else
              deviceid = deviceid.slice(1);
            ws.send("init:"+deviceid);
          };
          ws.onmessage = m => {
            if (init === 0)
            {
              init = 1;
              term.resize(Math.floor(document.documentElement.clientWidth / 9.4), Math.floor(document.documentElement.clientHeight / 19));
            }

            if (m.data.startsWith("cns:"))
            {
              term.write(m.data.substring(4));
            }
            else if (m.data.startsWith("fli:"))
            {
              dnl = document.createElement('A');
              dnl.download = m.data.substring(4);
              dnl.href = 'data:application/octet-stream;base64,';
            }
            else if (m.data.startsWith("flp:"))
            {
              dnl.href += m.data.substring(4);
            }
            else if (m.data.startsWith("fld"))
            {
              dnl.click();
            }
            else
            {
              console.log(m.data);
            }
          };
          ws.onclose = () => { 
            term.write('\r\n\r\n\x1B[1;3;31mConnection is closed.\x1B[0m\r\n'); 
          };
          ws.onerror = e => { 
            console.log(e);
          };
        } else {
          term.write('\x1B[1;3;31mWebSocket is NOT supported by your Browser!\x1B[0m'); 
        }
      </script>
    </body>
  </html>