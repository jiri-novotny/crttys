<!doctype html>
  <html>
    <head>
      <link rel="stylesheet" href="https://unpkg.com/xterm@4.11.0/css/xterm.css" />
      <script src="https://unpkg.com/xterm@4.11.0/lib/xterm.js"></script>
      <title>Device proxy - Terminal</title>
    </head>
    <body>
      <div id="terminal"></div>
      <script>
        var term = new Terminal();
        var line = "";
        var resp = "";
        var deviceid = "";
        var init = 0;
        term.open(document.getElementById('terminal'));
        term.onResize(e => {
          ws.send("size:" + e.cols + "x" + e.rows);
        });
        term.onData(e => {
          if (ws.readyState === WebSocket.OPEN)
          {
            switch (e) {
              case '\u001b[A': // arrows
              case '\u001b[B':
              case '\u001b[C':
              case '\u001b[D':
              case '\u001b[H': // insert home ...
              case '\u001b[F':
              case '\u001b[2~':
              case '\u001b[5~':
              case '\u001b[6~':
              case '\u001b[17~': // Fx
              case '\u001b[18~':
              case '\u001b[20~':
              case '\u001b[21~':
              case '\u001b[23~':
              case '\u001b[24~':
              case '\u0003': // Ctrl+C
                ws.send('data:' + e);
                break;
              case '\u001b[15~': // F5 override
                location.reload();
                break;
              case '\r': // Enter
                if (line === "exit")
                {
                  setTimeout(() => {
                    ws.close();
                  }, 250);
                }
              case '\t':
                ws.send("data:" + line + e);
                break;
              case '\u007F': // Backspace (DEL)
                // Do not delete the prompt
                if (line.length > 0)
                {
                  term.write('\b \b');
                  line = line.slice(0, -1);
                }
                break;
              default: // Print all other characters for demo
                term.write(e);
                line += e;
            }
          }
          else if (ws.readyState == WebSocket.CLOSED)
          {
            switch (e) {
              case '\u001b[15~': // F5 override
                location.reload();
                break;
              case '\u001b[19~': // F8 override
                var ws2 = new WebSocket(ws.url);
                ws2.onopen = ws.onopen;
                ws2.onmessage = ws.onmessage;
                ws2.onclose = ws.onclose;
                ws2.onerror = ws.onerror;
                ws = ws2;
                term.write('\r\n\r\n\x1B[1;3;32mConnection is restored.\x1B[0m\r\n'); 
                break;
            }
          }
        });

        if ("WebSocket" in window) {
          //var ws = new WebSocket(window.location.protocol.replace('http', 'ws') + "//" + document.location.host + "/ws");
          var ws = new WebSocket(window.location.origin.replace('http', 'ws') + "/ws");
          ws.onopen = () => {
            line = "";
            resp = "";
            init = 0;
            deviceid = window.location.pathname;
            if (deviceid.slice(-1) === '/')
              deviceid = deviceid.slice(1, -1);
            else
              deviceid = deviceid.slice(1);
            ws.send("init:"+deviceid);
          };
          ws.onmessage = m => {
            resp += m.data;
            if (resp === "\r\nLogin timed out after 60 seconds.\r\n")
            {
              ws.close();
            }

            if (line.length === 0)
            {
              if (init === 0)
              {
                init = 1;
                term.resize(Math.floor(document.documentElement.clientWidth / 9.4), Math.floor(document.documentElement.clientHeight / 19));
              }
              term.write(resp);
              resp = "";
            }
            else if (line.length <= resp.length)
            {
              resp = resp.slice(line.length);
              term.write(resp);
              resp = "";
              line = "";
            }
          };
          ws.onclose = () => { 
            term.write('\r\n\r\n\x1B[1;3;31mConnection is closed.\x1B[0m\r\n'); 
          };
          ws.onerror = e => { 
            console.log(e);
          };
        } else {
          term.write('\x1B[1;3;31mWebSocket is NOT supported by your Browser!\x1B[0m'); 
        }
      </script>
    </body>
  </html>